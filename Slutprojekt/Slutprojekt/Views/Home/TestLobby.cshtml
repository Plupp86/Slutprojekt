<div id="divPreviewImage">
	<!-- To display the browsed image-->
	<fieldset>
		<div class="form-group">
			<div class="col-lg-2">
				<image src="" id="previewImage" style="height:100px;width:100px;border:solid 2px dotted; float:left" />
			</div>
			<div class="col-lg-10" id="divOpponentPlayer">
				<!--To display image of opponent player-->
				<image src="" id="opponentImage" style="height:100px;width:100px;border:solid 2px dotted; float:right;" />
			</div>
		</div>
	</fieldset>
</div>

<div id="divRegister">
	<!-- Our Registration form-->
	<fieldset>
		<legend>Register</legend>
		<div class="form-group">
			<label for="name" class="col-lg-2 control-label">Name</label>
			<div class="col-lg-10">
				<input type="text" class="form-control" id="name"
					   placeholder="Name">
			</div>
		</div>
		<div class="form-group">
			<label for="image" class="col-lg-2 control-
             label">Avatar</label>
			<div class="col-lg-10">
				<input type="file" class="form-control" id="image" />
			</div>
		</div>
		<div class="form-group">
			<div class="col-lg-10 col-lg-offset-2">
				<button type="button" class="btn btn-primary"
						id="btnRegister">
					Register
				</button>
			</div>
		</div>
	</fieldset>
</div>

<div id="divFindOpponentPlayer">
	<!-- Section to display Find Opponent -->
	<fieldset>
		<legend>Find a player to play against!</legend>
		<div class="form-group">
			<input type="button" class="btn btn-primary"
				   id="btnFindOpponentPlayer" value="Find Opponent
             Player" />
		</div>
	</fieldset>
</div>
<div id="divFindingOpponentPlayer">
	<!-- Section to display
	opponent not found, wait -->
	<fieldset>
		<legend>Its lonely here!</legend>
		<div class="form-group">
			Looking for an opponent player. Waiting for someone to
			join!
		</div>
	</fieldset>
</div>
<div id="divGameInformation" class="form-group">
	<!-- Section to
	display game information-->
	<div class="form-group" id="divGameInfo"></div>
	<div class="form-group" id="divInfo"></div>
</div>
<div id="divGame" style="clear:both">
	<!-- Section where the game
	board would be displayed -->
	<fieldset>
		<legend>Game On</legend>
		<div id="divGameBoard" style="width:380px"></div>
	</fieldset>
</div>

@section scriptsSection
	{
	<script src="~/Scripts/signalr-client-1.0.0-alpha2-final.min.js"></script>

	<script>

		let hubUrl = '/gameHub';
		let httpConnection = new signalR.HttpConnection(hubUrl);
		let hubConnection = new signalR.HubConnection(httpConnection);
		var playerName = "";
		var playerImage = "";
		var hash = "#";
		hubConnection.start();

		$("#btnRegister").click(function () {
			playerName = $('#name').val();
			playerImage = $('#previewImage').attr('src');
			var data = playerName.concat(hash, playerImage);
			hubConnection.invoke('RegisterPlayer', data);
		});

		$("#image").change(function () {
			readURL(this);
		});

		function readURL(input) {
			if (input.files && input.files[0]) {
				var reader = new FileReader();
				reader.onload = imageIsLoaded;
				reader.readAsDataURL(input.files[0]);
			}
		}

		function imageIsLoaded(e) {
			if (e.target.result) {
				$('#previewImage').attr('src', e.target.result);
				$("#divPreviewImage").show();
			}
		};


		$("#btnFindOpponentPlayer").click(function () {
			hubConnection.invoke('FindOpponent');
		});

		hubConnection.on('registrationComplete', data => { //// Fires on registration complete. Invoked by server hub
			$("#divRegister").hide();  // hide the registration div
			$("#divFindOpponentPlayer").show(); // display find opponent player div.
		});

		hubConnection.on('opponentNotFound', data => { //// Fires when no opponent is found.
			$('#divFindOpponentPlayer').hide(); //// hide the find opponent player section.
			$('#divFindingOpponentPlayer').show(); //// display the finding opponent player div.
		});

		hubConnection.on('opponentFound', (data, image) => { //// Fires when opponent player is found.
			$('#divFindOpponentPlayer').hide();
			$('#divFindingOpponentPlayer').hide();
			$('#divGame').show();  //// Show game board section.
			$('#divGameInformation').show(); //// Show game information
			$('#divOpponentPlayer').show(); //// Show opponent player image.
			opponentImage = image;  //// sets the opponent player image for display
			$('#opponentImage').attr('src', opponentImage); //// Binds the opponent player image
			$('#divGameInfo').html("<br/><span><strong> Hey " + playerName + "! You are playing against <i>" + data + "</i></strong ></span > ");
			//// displays the information of opponent that the player is playing against.
			//// Draw the tic-tac-toe game board, A 3x3 grid :) by proper styling.
			for (var i = 0; i < 9; i++) {
				$("#divGameBoard").append("<span class='marker' id=" + i + " style='display:block;border:2px solid black; height: 100px; width: 100px; float: left; margin: 10px; '>" + i + "</span>");
			}
		});


		//// Triggers on clicking the grid cell.
		$(document).on('click', '.marker', function () {
			if ($(this).hasClass("notAvailable")) { //// Cell is already taken.
				return;
			}

			hubConnection.invoke('MakeAMove', $(this)[0].id); //// Cell is valid, send details to hub.
		});

		//// Fires when player has to make a move.
		hubConnection.on('waitingForMove', data => {
			$('#divInfo').html("<br/><span><strong> Your turn <i>" + playerName + "</i>! Make a winning move! </strong></span>");
		});

		//// Fires when move is made by either player.
		hubConnection.on('moveMade', data => {
			if (data.Image == playerImage) { //// Move made by player.
				$("#" + data.ImagePosition).addClass("notAvailable");
				$("#" + data.ImagePosition).css('background-image', 'url(' + data.Image + ')');
				$('#divInfo').html("<br/><strong>Waiting for <i>" + data.OpponentName + "</i> to make a move.</strong > ");
			}
			else {
				$("#" + data.ImagePosition).addClass("notAvailable");
				$("#" + data.ImagePosition).css('background-image', 'url(' + data.Image + ')');
				$('#divInfo').html("<br/><strong>Waiting for <i>" + data.OpponentName + "</i> to make a move.</strong > ");
			}
		});

		//// Fires when the game ends.
		hubConnection.on('gameOver', data => {
			$('#divGame').hide();
			$('#divInfo').html("<br/><span><strong>Hey " + playerName + "! " + data + " </strong></span>");
			$('#divGameBoard').html(" ");
			$('#divGameInfo').html(" ");
			$('#divOpponentPlayer').hide();
		});

		//// Fires when the opponent disconnects.
		hubConnection.on('opponentDisconnected', data => {
			$("#divRegister").hide();
			$('#divGame').hide();
			$('#divGameInfo').html(" ");
			$('#divInfo').html("<br/><span><strong>Hey " + playerName + "! Your opponent disconnected or left the battle! You are the winner! Hip Hip Hurray!!!</strong ></span > ");
		});

	</script>
}
